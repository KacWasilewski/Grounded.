<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Model Viewer</title>
    <style>
        body { margin: 0; }
        canvas { display: block; }
        .controls {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
            display: flex;
            gap: 10px;
        }
        .delete-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        .delete-btn:hover {
            background: #ff0000;
        }
    </style>
</head>
<body>
    <div class="controls">
        <a href="{{ url_for('index') }}">Back to List</a>
        <button class="delete-btn" onclick="deleteModel()">Delete Model</button>
    </div>
    <div id="error-message" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,0,0,0.8); color: white; padding: 20px; border-radius: 5px; display: none;"></div>
    
    <script src="{{ url_for('static', filename='js/three.min.js') }}"></script>
    <script>
        // Check if Three.js loaded correctly
        if (typeof THREE === 'undefined') {
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('error-message').textContent = 'Error: Three.js failed to load';
            throw new Error('Three.js failed to load');
        }
    </script>
    <script src="https://unpkg.com/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script src="https://unpkg.com/three@0.132.2/examples/js/loaders/OBJLoader.js"></script>
    <script>
        // Check if extensions loaded correctly
        if (typeof THREE.OrbitControls === 'undefined' || typeof THREE.OBJLoader === 'undefined') {
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('error-message').textContent = 'Error: Required Three.js extensions failed to load';
            throw new Error('Required Three.js extensions failed to load');
        }

        // Set up scene
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xeeeeee);
        
        // Set up camera with better initial position
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(10, 10, 10);
        camera.lookAt(0, 0, 0);
        
        // Set up renderer with antialias
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);
        
        // Enhanced lighting setup
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.7); // Increased intensity
        scene.add(ambientLight);
        
        const directionalLight1 = new THREE.DirectionalLight(0xffffff, 1.0); // Increased intensity
        directionalLight1.position.set(1, 1, 1);
        scene.add(directionalLight1);
        
        const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.7);
        directionalLight2.position.set(-1, -1, -1);
        scene.add(directionalLight2);
        
        // Add grid helper for better orientation
        const gridHelper = new THREE.GridHelper(10, 10);
        scene.add(gridHelper);
        
        // Load the OBJ model
        const loader = new THREE.OBJLoader();
        const modelPath = '/static/models/{{ filename }}';
        console.log('Loading model from:', modelPath);
        
        let currentModel = null; // Store reference to current model

        loader.load(
            modelPath,
            function(object) {
                console.log('Model loaded successfully');
                currentModel = object; // Store reference to the loaded model
                
                // Center the model at global origin (0,0,0)
                const box = new THREE.Box3().setFromObject(object);
                const center = box.getCenter(new THREE.Vector3());
                
                // Reset position to origin
                object.position.set(0, 0, 0);
                
                // Move all children to compensate for the center offset
                object.children.forEach(child => {
                    if (child.isObject3D) {
                        child.position.sub(center);
                    }
                });
                
                // Scale model to fit view
                const size = box.getSize(new THREE.Vector3());
                const maxDim = Math.max(size.x, size.y, size.z);
                const scale = 5 / maxDim;
                object.scale.multiplyScalar(scale);
                
                // Add some default material if none exists
                object.traverse(function(child) {
                    if (child.isMesh) {
                        if (!child.material) {
                            child.material = new THREE.MeshPhongMaterial({
                                color: 0x808080,
                                flatShading: true
                            });
                        }
                    }
                });
                
                scene.add(object);
                console.log('Model added to scene at origin');
                
                // Set camera to look at origin
                camera.lookAt(0, 0, 0);
            },
            function(xhr) {
                console.log((xhr.loaded / xhr.total * 100) + '% loaded');
            },
            function(error) {
                console.error('Error loading model:', error);
                document.getElementById('error-message').style.display = 'block';
                document.getElementById('error-message').textContent = 'Error loading 3D model: ' + error.message;
            }
        );
        
        // Delete function
        function deleteModel() {
            if (confirm('Are you sure you want to delete this model?')) {
                const filename = '{{ filename }}';
                fetch(`/delete/${filename}`, {
                    method: 'POST'
                })
                .then(response => {
                    if (response.ok) {
                        window.location.href = '{{ url_for("index") }}';
                    } else {
                        throw new Error('Failed to delete model');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('error-message').style.display = 'block';
                    document.getElementById('error-message').textContent = 'Error deleting model: ' + error.message;
                });
            }
        }
        
        // Enhanced orbit controls
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.screenSpacePanning = true;
        controls.minDistance = 1;
        controls.maxDistance = 50;
        controls.maxPolarAngle = Math.PI / 1.5;
        
        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();
        
        // Enhanced window resize handling
        window.addEventListener('resize', onWindowResize, false);
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>